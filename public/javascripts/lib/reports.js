// Generated by CoffeeScript 1.6.3
/*
Reports for Teacher Side
*/


/*
Functions
*/


(function() {
  var filteredData, issueData, sortedData;

  issueData = [];

  sortedData = [];

  filteredData = [];

  $(function() {
    var buildTable, filter;
    buildTable = function(arr) {
      var each, _i, _len, _results;
      $('#reportsBody').empty();
      _results = [];
      for (_i = 0, _len = arr.length; _i < _len; _i++) {
        each = arr[_i];
        _results.push($('#reportsBody').append('<tr class="issueRow" data-id=' + each['_id'] + '>' + '<td class="displayName">' + each['displayName'] + '</td>' + '<td class="issueTime" data-time=' + each['timeStamp'] + '>' + each['time'] + '</td>' + '</td><td class="waitTime">' + moment().minutes(each['totalWait']) + '</td>' + '<td>' + each['lesson'] + '</td>' + '<td>' + each['issue'] + '</td>' + '<td>' + each['comment'] + '</td>' + '</tr>'));
      }
      return _results;
    };
    $.get('/reportsInfo', function(data) {
      issueData = data;
      return buildTable(issueData);
    });
    $('th').each(function() {
      return $(this).on('click', function() {
        var value;
        value = $(this).attr('data-type');
        sortedData = _.sortBy(issueData, function(arr) {
          return arr[value];
        });
        return buildTable(sortedData);
      });
    });
    filter = function(arr, key, value1, value2) {
      var each, output, _i, _len;
      output = [];
      for (_i = 0, _len = arr.length; _i < _len; _i++) {
        each = arr[_i];
        if (each[key] >= value1 && each[key] <= value2) {
          output.push(each);
        }
      }
      return output;
    };
    /*
    	Filter/Search by name, date, time range, time waited, lesson, issue, comment
    */

    $('.search-menu').on('click', function() {
      var $searchInput, index, srchText;
      index = $(this).attr('data-type');
      srchText = $(this).text();
      $searchInput = $(this).closest('#reports').find('.search-input');
      $searchInput.find('.search-btn').text('Search by ' + srchText).attr('data-type', index);
      return $searchInput.removeClass('hidden').addClass('open');
    });
    $('#reports').on('click', '.search-btn', function(e) {
      var $searchval, index, searchResults, searchValue;
      e.preventDefault();
      $searchval = $(this).closest('.search-input').find('#search-value');
      searchValue = $searchval.val();
      index = $(this).attr('data-type');
      searchResults = search(issueData, searchValue, index);
      buildTable(searchResults);
      return $searchval.val('');
    });
    $('#reports').on('click', '.cancel-search', function(e) {
      var $searchInput;
      e.preventDefault();
      $searchInput = $(this).closest('#reports').find('.search-input');
      return $searchInput.addClass('hidden').removeClass('show');
    });
    $('#reports').on('click', '#date-btn', function() {
      return $('.date-row').removeClass('hidden').addClass('open');
    });
    $("#fromDate").datepicker({
      defaultDate: 0,
      changeMonth: true,
      numberOfMonths: 1,
      onClose: function(selectedDate) {
        return $("#toDate").datepicker("option", "minDate", selectedDate);
      }
    });
    $("#toDate").datepicker({
      defaultDate: "+1w",
      changeMonth: true,
      numberOfMonths: 1,
      onClose: function(selectedDate) {
        return $("#fromDate").datepicker("option", "maxDate", selectedDate);
      }
    });
    $('#reports').on('click', '#cancel-date', function() {
      return $('.date-row').addClass('hidden');
    });
    $('#reports').on('click', '#submit-date', function() {
      var fromDate, toDate;
      fromDate = $("#fromDate").val();
      toDate = $("#toDate").val();
      filteredData = filter(issueData, "date", fromDate, toDate);
      return buildTable(filteredData);
    });
    $('#fromTime').timepicker({
      'timeFormat': 'h:i A'
    });
    $('#toTime').timepicker({
      'timeFormat': 'h:i A'
    });
    $('#reports').on('click', '#time-btn', function() {
      return $('.time-row').removeClass('hidden').addClass('open');
    });
    $('#reports').on('click', '#cancel-time', function() {
      return $('.time-row').addClass('hidden');
    });
    $('#reports').on('click', '#submit-time', function() {
      var fromTime, toTime;
      fromTime = moment($("#fromTime").val()).format();
      console.log(fromTime);
      toTime = $("#toTime").val();
      filteredData = filter(issueData, "date", fromTime, toTime);
      return buildTable(filteredData);
    });
    $('#reports').on('click', '.reset-btn', function() {
      if ($(this).closest('.container').find('.filter-input').hasClass('open')) {
        console.log('whats up');
        $(this).closest('.container').find('.filter-input').removeClass('open').addClass('hidden');
      } else {
        console.log('no reset');
      }
      return buildTable(issueData);
    });
  });

}).call(this);
